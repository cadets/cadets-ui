{%- extends "base.html" -%}

{% import "bootstrap/utils.html" as utils %}

{% block content %}
<div class="container">
  {{ super() }}

  <img id="logo" src="/static/images/logo.png"/>

  <div id="sidebar">
    <h3>Worksheet</h3>

    <div class="panel panel-info">
      <div class="panel-heading">Available nodes:</div>
      <div class="panel-body">
        <table id="nodelist" class="table table-striped"></table>
      </div>
    </div>

    <div class="panel panel-info">
      <div class="panel-heading">Available edges:</div>
      <div class="panel-body">
        <table id="edgelist" class="table table-striped"></table>
      </div>
    </div>

    <label for="layout-picker" class="control-label">Auto-layout</label>
    <select id="layout-picker" onchange="layout(worksheet, this.value)">
      <option value="dagre">dagre</option>
      <option value="cose">CoSE</option>
      <option value="cose-bilkent">CoSE (Bilkent)</option>
    </select>
  </div>

  <div id="content">
    <div class="graph well" id="worksheet"></div>
    <div class="graph well" id="aux-info"></div>
  </div>
</div>

{% endblock %}

{% block scripts -%}
  {{ super() }}

  <script type="text/javascript">
$(document).ready(function() {
  $(window).resize(function() {
    // The height of the #content area (in ems) should be the height of the
    // window minus that of the navbar, minus some margin and padding.
    var fontSize = parseFloat($("html").css("font-size"));
    var height = ($(this).height() - $("nav.navbar").height()) / fontSize - 13;

    $("#worksheet").height(fontSize * (height - 20));
    $("#aux-info").height(fontSize * 20);
  }).resize();
});

var worksheet = cytoscape({
  container: document.getElementById('worksheet'),
  boxSelectionEnabled: true,
});

var aux = cytoscape({
  container: document.getElementById('aux-info'),
  boxSelectionEnabled: true,
});

var layout = function(graph, algorithm) {
  graph.layout({
    name: algorithm,
    rankDir: 'LR',
    animate: false,
  })
  .run();
};

$.ajax('/static/style/cytoscape.css', {
  dataType: 'text',
  mimeType: 'text/css',
  success: function(result) {
    worksheet.style(result);
    aux.style(result);
  }
});

var aux_node = function(id) {
  $.getJSON('/onehop/' + id, function(result) {
    aux.remove('node');
    aux.add(result);

    aux.$('node').on('tap', function(ev) {
      alert(ev.target.id());
    });

    layout(aux, 'dagre');
  });
};

$.getJSON('/edges', function(result) {
  var edgelist = $('#edgelist');
  edgelist.empty();

  for (let node of result) {
    edgelist.append(`
      <tr>
        <td><i class="material-icons">${node.data.icon}</i></td>
        <td>${node.data.type}</td>
        <td>${node.data.label}</td>
        <td>
          <a onclick="aux_node('${node.data.id}')">
            ${node.data.id.substring(0, 8)}
          </a>
        </td>
      </tr>`);
  }
});

$.getJSON('/nodes', function(result) {
  var nodelist = $('#nodelist');
  nodelist.empty();

  for (let node of result) {
    nodelist.append(`
      <tr>
        <td><i class="material-icons">${node.data.icon}</i></td>
        <td>${node.data.type}</td>
        <td>${node.data.label}</td>
        <td>
          <a onclick="aux_node('${node.data.id}')">
            ${node.data.id.substring(0, 8)}
          </a>
        </td>
      </tr>`);
  }
});
  </script>
{% endblock %}
